<!doctype html>
<html lang="en">

  <head>
    <!-- Adding Adobe Analytics, the google Analytics will be removed after abobe will be well configured -->
    <script id="adobe_dtm" src="//www.redhat.com/dtm.js" type="text/javascript"></script>

    <!-- Global site tag (gtag.js) - Google Analytics, when Adobe Analytics is added, remove next line -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-119267218-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-119267218-1');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1, shrink-to-fit=no" />
    <meta name="go-import" content="kubevirt.io/kubevirt git https://github.com/kubevirt/kubevirt">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Non Dockerized Build</title>
    <meta name="description" content="Virtual Machine Management on Kubernetes
">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/main.css" }}">
    <link rel="canonical" href="http://localhost:4000/2018/Non-Dockerized-Build.html">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href=/assets/favicon/favicon.png>
</head>


  <body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="position: absolute; top: 0; background-image: linear-gradient(to top, #3accc5, #00aab2); width: 100%;">
        <a class="navbar-brand" href="/">
    <img src="/assets/images/KubeVirt_logo_color.svg" height="30" class="d-inline-block align-top" alt="">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <i class="fas fa-th-large"></i>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
      

      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/blogs/">Blogs</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/videos/">Videos</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/docs/">Docs</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/community/">Community</a>
        </li>
      

    </ul>
  </div>

    </nav>

    <section style="margin-top: 60px;">
      <div class="container">
  <div class="row">
    <div class="col">
      <div class="post blogContent">

        <header class="post-header">
          <h1></h1>
          <h1 class="post-title">Non Dockerized Build</h1>
          <span class="blogAuthor">by yuvalif - </span><span class="post-meta">Jun 7, 2018  </span>
        </header>
        <article class="post-content">
          <h1 id="introduction">Introduction</h1>

<p>In this post we will set up an alternative to the existing containerized build system used in KubeVirt.</p>

<p>A <a href="../assets/2018-06-07-Non-Dockerized-Build/Makefile.nocontainer">new makefile</a> will be presented here, which you can for experimenting (if you are brave enough…)</p>

<h1 id="why">Why?</h1>

<p>Current build system for KubeVirt is done inside docker. This ensures a robust and consistent build environment:</p>
<ul>
  <li>No need to install system dependencies</li>
  <li>Controlled versions of these dependencies</li>
  <li>Agnostic of local golang environment</li>
</ul>

<p>So, in general, <strong>you should just use the dockerized build system</strong>.</p>

<p>Still, there are some drawbacks there:</p>
<ul>
  <li>Tool integration:
    <ul>
      <li>Since your tools are not running in the dockerized environment, they may give different outcome than the ones running in the dockerized environment</li>
      <li>Invoking any of the dockerized scripts (under <code class="highlighter-rouge">hack</code> directory) may be inconsistent with the outside environment (e.g. file path is different than the one on your machine)</li>
    </ul>
  </li>
  <li>Build time: the dockerized build has some small overheads, and some improvements are still needed to make sure that caching work properly and build is optimized</li>
  <li>And last, but not least, <em>sometimes it is just hard to resist the tinkering…</em></li>
</ul>

<h2 id="how">How?</h2>

<p>Currently, the Makefile includes targets that address different things: building, dependencies, cluster management, testing etc. - here I tried to modify the minimum which is required for non-containerized build. Anything not related to it, should just be done using the existing Makefile.</p>

<blockquote>
  <p>Note that cross compilation is not covered here (e.g. building virtctl for mac and windows)</p>
</blockquote>

<h3 id="prerequisites">Prerequisites</h3>

<p>Best place to look for that is in the docker file definition for the build environment: <a href="https://github.com/kubevirt/kubevirt/blob/master/hack/docker-builder/Dockerfile">hack/docker-builder/Dockerfile</a></p>

<p>Note that not everything from there is needed for building, so the bare minimum on Fedora27 would be:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo dnf install -y git
sudo dnf install -y libvirt-devel
sudo dnf install -y golang
sudo dnf install -y docker
sudo dnf install -y qemu-img
</code></pre></div></div>
<p><em>Similarly to the containerized case</em>, docker is still needed (e.g. all the cluster stuff is done via docker),  and therefore, any docker related preparations are needed as well. This would include running docker on startup and making sure that docker commands does not need root privileges. On Fedora27 this would mean:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo groupadd docker
sudo usermod -aG docker $USER
sudo systemctl enable docker
sudo systemctl start docker
</code></pre></div></div>
<p>Now, getting the actual code could be done either via <code class="highlighter-rouge">go get</code> (don’t forget to set the <code class="highlighter-rouge">GOPATH</code> environment variable):</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go get -d kubevirt.io/kubevirt/...
</code></pre></div></div>
<p>Or <code class="highlighter-rouge">git clone</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir -p $GOPATH/src/kubevirt.io/ &amp;&amp; cd $GOPATH/src/kubevirt.io/
git clone https://github.com/kubevirt/kubevirt
</code></pre></div></div>

<h3 id="makefilenocontainer"><a href="../assets/2018-06-07-Non-Dockerized-Build/Makefile.nocontainer">Makefile.nocontainer</a></h3>
<div class="language-makefile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">all</span><span class="o">:</span> <span class="nf">build</span>

<span class="nl">bootstrap</span><span class="o">:</span>
    <span class="err">go</span> <span class="err">get</span> <span class="err">-u</span> <span class="err">github.com/onsi/ginkgo/ginkgo</span>
    <span class="err">go</span> <span class="err">get</span> <span class="err">-u</span> <span class="err">mvdan.cc/sh/cmd/shfmt</span>
    <span class="err">go</span> <span class="err">get</span> <span class="err">-u</span> <span class="err">-d</span> <span class="err">k8s.io/code-generator/cmd/deepcopy-gen</span>
    <span class="err">go</span> <span class="err">get</span> <span class="err">-u</span> <span class="err">-d</span> <span class="err">k8s.io/code-generator/cmd/defaulter-gen</span>
    <span class="err">go</span> <span class="err">get</span> <span class="err">-u</span> <span class="err">-d</span> <span class="err">k8s.io/code-generator/cmd/openapi-gen</span>
    <span class="err">cd</span> <span class="err">${GOPATH}/src/k8s.io/code-generator/cmd/deepcopy-gen</span> <span class="err">&amp;&amp;</span> <span class="err">git</span> <span class="err">checkout</span> <span class="err">release-1.9</span> <span class="err">&amp;&amp;</span> <span class="err">go</span> <span class="err">install</span>
    <span class="err">cd</span> <span class="err">${GOPATH}/src/k8s.io/code-generator/cmd/defaulter-gen</span> <span class="err">&amp;&amp;</span> <span class="err">git</span> <span class="err">checkout</span> <span class="err">release-1.9</span> <span class="err">&amp;&amp;</span> <span class="err">go</span> <span class="err">install</span>
    <span class="err">cd</span> <span class="err">${GOPATH}/src/k8s.io/code-generator/cmd/openapi-gen</span> <span class="err">&amp;&amp;</span> <span class="err">git</span> <span class="err">checkout</span> <span class="err">release-1.9</span> <span class="err">&amp;&amp;</span> <span class="err">go</span> <span class="err">install</span>

<span class="nl">generate</span><span class="o">:</span>
    <span class="err">./hack/generate.sh</span>

<span class="nl">apidocs</span><span class="o">:</span> <span class="nf">generate</span>
    <span class="err">./hack/gen-swagger-doc/gen-swagger-docs.sh</span> <span class="err">v1</span> <span class="err">html</span>

<span class="nl">build</span><span class="o">:</span> <span class="nf">check</span>
    <span class="err">go</span> <span class="err">install</span> <span class="err">-v</span> <span class="err">./cmd/...</span> <span class="err">./pkg/...</span>
    <span class="err">./hack/copy-cmd.sh</span>

<span class="nl">test</span><span class="o">:</span> <span class="nf">build</span>
    <span class="err">go</span> <span class="err">test</span> <span class="err">-v</span> <span class="err">-cover</span> <span class="err">./pkg/...</span>

<span class="nl">check</span><span class="o">:</span>
    <span class="err">./hack/check.sh</span>

<span class="nv">OUT_DIR</span><span class="o">=</span>./_out
<span class="nv">TESTS_OUT_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">OUT_DIR</span><span class="k">}</span>/tests

<span class="nl">functest</span><span class="o">:</span> <span class="nf">build</span>
    <span class="err">go</span> <span class="err">build</span> <span class="err">-v</span> <span class="err">./tests/...</span>
    <span class="err">ginkgo</span> <span class="err">build</span> <span class="err">./tests</span>
    <span class="err">mkdir</span> <span class="err">-p</span> <span class="err">${TESTS_OUT_DIR}/</span>
    <span class="err">mv</span> <span class="err">./tests/tests.test</span> <span class="err">${TESTS_OUT_DIR}/</span>
    <span class="err">./hack/functests.sh</span>

<span class="nl">cluster-sync</span><span class="o">:</span> <span class="nf">build</span>
    <span class="err">./hack/build-copy-artifacts.sh</span>
    <span class="err">./hack/build-manifests.sh</span>
    <span class="err">./hack/build-docker.sh</span> <span class="err">build</span>
    <span class="err">./cluster/clean.sh</span>
    <span class="err">./cluster/deploy.sh</span>

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">bootstrap generate apidocs build test check functest cluster-sync</span>
</code></pre></div></div>
<h3 id="targets">Targets</h3>

<p>To execute any of the targets use:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make -f Makefile.nocontainer &lt;target&gt;
</code></pre></div></div>
<p>File has the following targets:</p>

<ul>
  <li><strong>bootstrap</strong>: this is actually part of the prerequisites, but added all golang tool dependencies here, since this is agnostic of the running platform Should be called once
    <ul>
      <li>Note that the k8s code generators use specific version</li>
      <li>Note that these are not code dependencies, as they are handled by using a <code class="highlighter-rouge">vendor</code> directory, as well as the distclean,  deps-install and deps-update targets in the <a href="ttps://github.com/kubevirt/kubevirt/blob/master/Makefile">standard makefile</a></li>
    </ul>
  </li>
  <li><strong>generate</strong>: Calling <a href="https://github.com/kubevirt/kubevirt/blob/master/hack/generate.sh">hack/generate.sh</a> script similarly to the <a href="https://github.com/kubevirt/kubevirt/blob/master/Makefile">standard makefile</a>. It builds all generators (under the <code class="highlighter-rouge">tools</code> directory) and use them to generate: test mocks, KubeVirt resources and test yamls</li>
  <li><strong>apidocs</strong>: this is similar to apidocs target in the <a href="ttps://github.com/kubevirt/kubevirt/blob/master/Makefile">standard makefile</a></li>
  <li><strong>build</strong>: this is building all product binaries, and then using a script (<a href="../assets/2018-06-07-Non-Dockerized-Build/copy-cmd.sh">copy-cmd.sh</a>, should be placed under: <code class="highlighter-rouge">hack</code>) to copy the binaries from their standard location into the <code class="highlighter-rouge">_out</code> directory, where the cluster management scripts expect them</li>
  <li><strong>test</strong>: building and running unit tests
check: using similar code to the one used in the standard makefile: formatting files, fixing package imports and calling go vet</li>
  <li><strong>functest</strong>: building and running integration tests. After tests are built , they are moved to the <code class="highlighter-rouge">_out</code> directory so that the standard script for running integration tests would find them</li>
  <li><strong>cluster-sync</strong>: this is the only “cluster management” target that had to be modified from the standard makefile</li>
</ul>

        </article>

        

<a class="twitter-share-button" href="https://twitter.com/intent/tweet?text=Non Dockerized Build&url=/2018/Non-Dockerized-Build.html"><span>Tweet</span></a>
<hr/>


      </div>
    </div>
  </div>
</div>

    </section>

    <footer class="footer">
      <div class="container">
  <div class="row">
    <div class="col-sm-12 col-md-6 align-self-start">
      &copy; 2018 KubeVirt | <a href="/privacy">Privacy Statement</a>
    </div>
    <div class="col-sm-12 col-md-6 align-self-end social-link">
      <a href="https://twitter.com/kubevirt" style="margin-right: 1rem;">
        <i class="fab fa-twitter fa-lg"></i>
      </a>
      <a href="https://github.com/kubevirt" style="margin-right: 1rem;">
        <i class="fab fa-github fa-lg"></i>
      </a>
      <a href="https://groups.google.com/forum/#!forum/kubevirt-dev" style="margin-right: 1rem;">
        <i class="fas fa-envelope fa-lg"></i>
      </a>
      <a href="https://calendar.google.com/calendar/embed?src=18pc0jur01k8f2cccvn5j04j1g%40group.calendar.google.com&ctz=Etc%2FGMT">
        <i class="fas fa-calendar fa-lg"></i>
      </a>
    </div>
  </div>
</div>
<!--


    <h1>kubevirt.io</h1>


    <a href="https://twitter.com/kubevirt" class="btn btn-secondary footerIcon" title="Twitter">
      <span class="icon">
        <svg viewBox="0 0 16 16">
          <path fill="#fff" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
          c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
        </svg>
      </span>
    </a>


    <a href="https://github.com/kubevirt"  class="btn btn-secondary footerIcon" title="Github">
      <span class="icon">
        <svg viewBox="0 0 16 16">
          <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
        </svg>
      </span>
    </a>

    <a href="https://kiwiirc.com/client/irc.freenode.net/kubevirt" class="btn btn-secondary footerIcon" title="Mailing List" style="padding-top: 18px;">
      <span >IRC</span>
    </a>


    <a href="https://groups.google.com/forum/#!forum/kubevirt-dev" class="btn btn-secondary footerIcon">
      <span class="icon">
        <svg viewBox="0 0 16 16">
          <path style="fill:currentColor;fill-opacity:1;stroke:none" d="M 0 2 L 0 14 L 16 14 L 16 2 L 0 2 z M 1.4140625 3 L 14.585938 3 L 8 9.5859375 L 1.4140625 3 z M 1 4 L 5 8 L 1 12 L 1 4 z M 15 4 L 15 12 L 11 8 L 15 4 z M 5.7070312 8.7070312 L 8 11 L 10.292969 8.7070312 L 14.585938 13 L 1.4140625 13 L 5.7070312 8.7070312 z " id="rect4144" class="ColorScheme-Text"></path>
        </svg>
      </span>
    </a>


    <a href="https://calendar.google.com/calendar/embed?src=18pc0jur01k8f2cccvn5j04j1g%40group.calendar.google.com&ctz=Etc%2FGMT" class="btn btn-secondary footerIcon" title="Upcoming and past events">
      <span class="icon">
        <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" viewBox="0 -256 1850 1850" id="svg3025" version="1.1" inkscape:version="0.48.3.1 r9886" width="100%" height="100%" sodipodi:docname="calendar_font_awesome.svg">
          <metadata id="metadata3035">
            <rdf:RDF>
              <cc:Work rdf:about="">
                <dc:format>image/svg+xml</dc:format>
                <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/>
              </cc:Work>
            </rdf:RDF>
          </metadata>
          <defs id="defs3033"/>
          <sodipodi:namedview pagecolor="#ffffff" bordercolor="#666666" borderopacity="1" objecttolerance="10" gridtolerance="10" guidetolerance="10" inkscape:pageopacity="0" inkscape:pageshadow="2" inkscape:window-width="640" inkscape:window-height="480" id="namedview3031" showgrid="false" inkscape:zoom="0.13169643" inkscape:cx="896" inkscape:cy="896" inkscape:window-x="0" inkscape:window-y="25" inkscape:window-maximized="0" inkscape:current-layer="svg3025"/>
          <g transform="matrix(1,0,0,-1,91.118644,1297.8644)" id="g3027">
            <path d="M 128,-128 H 416 V 160 H 128 v -288 z m 352,0 H 800 V 160 H 480 V -128 z M 128,224 H 416 V 544 H 128 V 224 z m 352,0 H 800 V 544 H 480 V 224 z M 128,608 H 416 V 896 H 128 V 608 z m 736,-736 h 320 V 160 H 864 V -128 z M 480,608 H 800 V 896 H 480 V 608 z m 768,-736 h 288 V 160 H 1248 V -128 z M 864,224 h 320 V 544 H 864 V 224 z m -352,864 v 288 q 0,13 -9.5,22.5 -9.5,9.5 -22.5,9.5 h -64 q -13,0 -22.5,-9.5 Q 384,1389 384,1376 v -288 q 0,-13 9.5,-22.5 9.5,-9.5 22.5,-9.5 h 64 q 13,0 22.5,9.5 9.5,9.5 9.5,22.5 z m 736,-864 h 288 V 544 H 1248 V 224 z M 864,608 h 320 V 896 H 864 V 608 z m 384,0 h 288 V 896 H 1248 V 608 z m 32,480 v 288 q 0,13 -9.5,22.5 -9.5,9.5 -22.5,9.5 h -64 q -13,0 -22.5,-9.5 -9.5,-9.5 -9.5,-22.5 v -288 q 0,-13 9.5,-22.5 9.5,-9.5 22.5,-9.5 h 64 q 13,0 22.5,9.5 9.5,9.5 9.5,22.5 z m 384,64 V -128 q 0,-52 -38,-90 -38,-38 -90,-38 H 128 q -52,0 -90,38 -38,38 -38,90 v 1280 q 0,52 38,90 38,38 90,38 h 128 v 96 q 0,66 47,113 47,47 113,47 h 64 q 66,0 113,-47 47,-47 47,-113 v -96 h 384 v 96 q 0,66 47,113 47,47 113,47 h 64 q 66,0 113,-47 47,-47 47,-113 v -96 h 128 q 52,0 90,-38 38,-38 38,-90 z" id="path3029" inkscape:connector-curvature="0" style="fill:currentColor"/>
          </g>
        </svg>
      </span>
    </a>

  </div>
</footer> -->

    </footer>

    <script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js" integrity="sha384-3LK/3kTpDE/Pkp8gTNp2gR/2gOiwQ6QaO7Td0zV76UFJVhqLl4Vl3KL1We6q6wR9" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
    <script type="text/javascript">
      if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
          _satellite.pageBottom();
      }
    </script>
  </body>
</html>
