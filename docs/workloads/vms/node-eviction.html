<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1, shrink-to-fit=no" />
    <meta name="go-import" content="kubevirt.io/kubevirt git https://github.com/kubevirt/kubevirt">
    <meta name="go-import" content="kubevirt.io/containerized-data-importer git https://github.com/kubevirt/containerized-data-importer">
    <meta name="description" content="Virtual Machine Management on Kubernetes
">
    <title>Node Eviction</title>

    <link rel="apple-touch-icon" sizes="72x72" href="/assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/favicon/site.webmanifest">
    <link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#ffffff">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://www.kubevirt.io//docs/workloads/vms/node-eviction.html">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
</head>


  <body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" role="navigation">
        <a class="navbar-brand" href="/">
    <img src="/assets/images/KubeVirt_logo_color.svg" class="navbar-brand-image d-inline-block align-top" alt="KubeVirt.io">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <i class="fas fa-th-large"></i>
  </button>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav">
      

      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/blogs/">Blogs</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/videos/">Videos</a>
        </li>
      
        <li  class="nav-item active" >
          <a class="nav-link text-uppercase" href="/docs/">Docs</a>
        </li>
      
        <li  class="nav-item" >
          <a class="nav-link text-uppercase" href="/community/">Community</a>
        </li>
      

    </ul>
  </div>

    </nav>

    <main role="main" style="margin-top: 60px;">
      <div class="container-fluid">
        <div class="row">
          <h1 class="page-title offset-lg-1">Docs</h1>
        </div>
        <div class="row">
          <div class="col-sm-12 col-md-4 col-lg-3 offset-lg-1">
            <!-- <div class="search-bar">
              <form action="/search.html" method="get">
                <label for="search-box">Search</label>
                <input type="text" id="search-box" name="query">
                <input type="submit" value="search">
              </form>
            </div> -->
            
  
    <h3 class="docs-title">
      <a href="/docs"  class="docs-title--item" >Introduction</a>
    </h3>
    
  
    <h3 class="docs-title">
      <a href="/docs/installation.html"  class="docs-title--item" >Installation</a>
    </h3>
    
    <ul class="docs-navigation">
      
        <li class="docs-navigation--item">
          <a href="/docs/installation/admission-controllers.html"  class="docs-navigation--item_link" >
            Admission Controllers
          </a>
          
        </li>
      
        <li class="docs-navigation--item">
          <a href="/docs/installation/feature-matrix.html"  class="docs-navigation--item_link" >
            Feature Matrix
          </a>
          
        </li>
      
    </ul>
    
  
    <h3 class="docs-title">
      <a href="/docs/usage.html"  class="docs-title--item" >Usage</a>
    </h3>
    
  
    <h3 class="docs-title">
      <a href="/docs/authorization.html"  class="docs-title--item" >Authorization</a>
    </h3>
    
  
    <h3 class="docs-title">
      <a href="/docs/workloads.html"  class="docs-title--item" >Workloads</a>
    </h3>
    
    <ul class="docs-navigation">
      
        <li class="docs-navigation--item">
          <a href="/docs/workloads/virtual-machines.html"  class="docs-navigation--item_link" >
            Virtual Machines
          </a>
          
            <ul class="docs-navigation_sub">
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/vms/creation.html"  class="docs-navigation_sub--item_link" >
                    Creation
                  </a>
                </li>
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/vms/node-eviction.html"  class="docs-navigation_sub--item_link active" >
                    Node Eviction
                  </a>
                </li>
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/vms/presets.html"  class="docs-navigation_sub--item_link" >
                    Presets
                  </a>
                </li>
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/vms/life-cycle.html"  class="docs-navigation_sub--item_link" >
                    Life-cycle
                  </a>
                </li>
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/vms/dns-for-services.html"  class="docs-navigation_sub--item_link" >
                    DNS for Services and VirtualMachineInstances
                  </a>
                </li>
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/vms/expose-vm-services.html"  class="docs-navigation_sub--item_link" >
                    Expose VirtualMachineInstances as Services
                  </a>
                </li>
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/vms/create-networkpolicy.html"  class="docs-navigation_sub--item_link" >
                    Create Networkpolicy
                  </a>
                </li>
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/vms/graphical-and-console-access.html"  class="docs-navigation_sub--item_link" >
                    Graphical and Console Access
                  </a>
                </li>
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/vms/disks-and-volumes.html"  class="docs-navigation_sub--item_link" >
                    Disks and Volumes
                  </a>
                </li>
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/vms/interfaces-networks.html"  class="docs-navigation_sub--item_link" >
                    Interfaces and Networks
                  </a>
                </li>
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/vms/startup-scripts.html"  class="docs-navigation_sub--item_link" >
                    Startup Scripts
                  </a>
                </li>
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/vms/guest-os-info.html"  class="docs-navigation_sub--item_link" >
                    Guest Operating System Information
                  </a>
                </li>
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/vms/virtual-hardware-config.html"  class="docs-navigation_sub--item_link" >
                    Virtualized Hardware Configuration
                  </a>
                </li>
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/vms/vms-to-nodes.html"  class="docs-navigation_sub--item_link" >
                    Assigning VMs to Nodes
                  </a>
                </li>
            
            </ul>
          
        </li>
      
        <li class="docs-navigation--item">
          <a href="/docs/workloads/controllers.html"  class="docs-navigation--item_link" >
            Controllers
          </a>
          
            <ul class="docs-navigation_sub">
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/controllers/virtualmachine.html"  class="docs-navigation_sub--item_link" >
                    VirtualMachine
                  </a>
                </li>
            
                <li class="docs-navigation_sub--item">
                  <a href="/docs/workloads/controllers/virtual-machine-replica-set.html"  class="docs-navigation_sub--item_link" >
                    VirtualMachineInstanceReplicaSet
                  </a>
                </li>
            
            </ul>
          
        </li>
      
        <li class="docs-navigation--item">
          <a href="/docs/workloads/templates.html"  class="docs-navigation--item_link" >
            Templates
          </a>
          
        </li>
      
        <li class="docs-navigation--item">
          <a href="/docs/workloads/annotations-labels.html"  class="docs-navigation--item_link" >
            Annotations and Labels
          </a>
          
        </li>
      
    </ul>
    
  
    <h3 class="docs-title">
      <a href="/docs/additional-resources.html"  class="docs-title--item" >Additional Resources</a>
    </h3>
    
  


          </div>
          <div class="col-sm-12 col-md-8 col-lg-8 docs">
            <h1 id="virtualmachineinstance-node-eviction">VirtualMachineInstance Node Eviction</h1>

<p>Before removing a kubernetes node from the cluster, users will want to ensure
that VirtualMachineInstances have been gracefully terminated before powering down the
node. Since all VirtualMachineInstances are backed by a Pod, the recommended method
of evicting VirtualMachineInstances is to use the <strong>kubectl drain</strong> command, or in the
case of OpenShift the <strong>oc adm drain</strong> command.</p>

<h2 id="how-to-evict-all-vms-on-a-node">How to Evict all VMs on a Node</h2>

<p>Select the node you’d like to evict VirtualMachineInstances from by identifying the
node from the list of cluster nodes.</p>

<p><code class="highlighter-rouge">kubectl get nodes</code></p>

<p>The following command will gracefully terminate all VMs on a specific node.
Replace **<node name="">** with the target node you want the eviction to occur on.</node></p>

<p><code class="highlighter-rouge">kubectl drain &lt;node name&gt; --delete-local-data --ignore-daemonsets=true --force --pod-selector=kubevirt.io=virt-launcher</code></p>

<p>Below is a break down of why each argument passed to the drain command is
required.</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">kubectl drain &lt;node name&gt;</code> is selecting a specific node as a target for
the eviction</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">--delete-local-data</code> is a required flag that is necessary for removing
any pod that utilizes an emptyDir volume. The VirtualMachineInstance Pod does use
emptryDir volumes, however the data in those volumes are ephemeral which means
it is safe to delete after termination.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">--ignore-daemonsets=true</code> is a required flag because every node running
a VirtualMachineInstance will also be running our helper DaemonSet called virt-handler.
DaemonSets are not allowed to be evicted using <strong>kubectl drain</strong>. By default,
if this command encounters a DaemonSet on the target node, the command will
fail. This flag tells the command it is safe to proceed with the eviction and
to just ignore DaemonSets.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">--force</code> is a required flag because VirtualMachineInstance pods are not owned by
a ReplicaSet or DaemonSet controller. This means kubectl can’t guarantee that
the pods being terminated on the target node will get re-scheduled replacements
placed else where in the cluster after the pods are evicted. KubeVirt has its
own controllers which manage the underlying VirtualMachineInstance pods. Each
controller behaves differently to a VirtualMachineInstance being evicted. That behavior
is outlined futher down in this document.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">--pod-selector=kubevirt.io=virt-launcher</code> means only VirtualMachineInstance pods
managed by KubeVirt will be removed from the node.</p>
  </li>
</ul>

<h2 id="how-to-evict-all-vms-and-pods-on-a-node">How to Evict all VMs and Pods on a Node</h2>

<p>By removing the <strong>–pod-selector</strong> argument from the previous command, we can
issue the eviction of all Pods on a node. This command ensures Pods
associated with VMs as well as all other Pods are evicted from the target node.</p>

<p><code class="highlighter-rouge">kubectl drain &lt;node name&gt; --delete-local-data --ignore-daemonsets=true --force</code></p>

<h2 id="re-enabling-a-node-after-eviction">Re-enabling a Node after Eviction</h2>

<p>The <strong>kubectl drain</strong> will result in the target node being marked as
unschedulable. This means the node will not be eligible for running new
VirtualMachineInstances or Pods.</p>

<p>If it is decided that the target node should become schedulable again, the
following command must be run.</p>

<p><code class="highlighter-rouge">kubectl uncordon &lt;node name&gt;</code></p>

<p>or in the case of OpenShift</p>

<p><code class="highlighter-rouge">oc adm uncordon &lt;node name</code></p>

<h2 id="shutting-down-a-node-after-eviction">Shutting down a Node after Eviction</h2>

<p>From KubeVirt’s perspective, a node is safe to shutdown once all VirtualMachineInstances
have been evicted from the node. In a multi-use cluster where VirtualMachineInstances
are being scheduled along side other containerized workloads, it is up to the
cluster admin to ensure all other pods have been safely evicted before powering
down the node.</p>

<h2 id="virtualmachine-evictions">VirtualMachine Evictions</h2>

<p>The eviction of any VirtualMachineInstance that is owned by a VirtualMachine
set to <strong>running=true</strong> will result in the VirtualMachineInstance being re-scheduled to
another node.</p>

<p>The VirtualMachineInstance in this case will be forced to power down and restart on
another node. In the future once KubeVirt introduces live migration support,
the VM will be able to seamlessly migrate to another node during eviction.</p>

<h2 id="virtualmachineinstancereplicaset-eviction-behavior">VirtualMachineInstanceReplicaSet Eviction Behavior</h2>

<p>The eviction of VirtualMachineInstances owned by a VirtualMachineInstanceReplicaSet will result
in the VirtualMachineInstanceReplicaSet scheduling replacements for the evicted
VirtualMachineInstances on other nodes in the cluster.</p>

<h2 id="virtualmachineinstance-eviction-behavior">VirtualMachineInstance Eviction Behavior</h2>

<p>VirtualMachineInstances not backed by either a VirtualMachineInstanceReplicaSet or an
VirtualMachine object will not be re-scheduled after eviction.</p>

          </div>
        </div>
      </div>
    </main>

    <footer class="footer" role="footer">
      <div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-sm-12 col-md-5">
      <p class="privacy-statement text-sm-left" style="text-align: center;">
        &copy; <script type="text/javascript"> document.write(new Date().getFullYear()); </script> KubeVirt | <a href="/privacy" class="privacy-statement-link">Privacy Statement</a>
      </p>
    </div>
    <div class="col-sm-12 col-md-5" style="text-align: center;">
      <p class="text-md-right">
        <a href="https://twitter.com/kubevirt" aria-label="Visit us on Twitter" class="link-social-twitter">
          <i class="fab fa-twitter fa-lg"></i>
        </a>
        <a href="https://github.com/kubevirt" aria-label="View our repo on GitHub" class="link-social-github">
          <i class="fab fa-github fa-lg"></i>
        </a>
        <a href="https://groups.google.com/forum/#!forum/kubevirt-dev" aria-label="Send us an email" class="link-social-mail">
          <i class="fas fa-envelope fa-lg"></i>
        </a>
        <a href="https://calendar.google.com/calendar/embed?src=18pc0jur01k8f2cccvn5j04j1g%40group.calendar.google.com&ctz=Etc%2FGMT"
            aria-label="See our calendar"
            class="link-social-calendar">
          <i class="fas fa-calendar fa-lg"></i>
        </a>
      </p>
    </div>
  </div>
  <div class="row">
    <div class="col offset-md-1 text-sm-left footer-licensing" style="text-align: center;">
      Code licensed under <a href="https://github.com/kubevirt/kubevirt/blob/master/LICENSE">Apache 2.0</a>,
      site under <a href="https://github.com/kubevirt/kubevirt.github.io/blob/master/LICENSE">MIT</a>.
    </div>
  </div>
</div>

    </footer>

    <script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js" integrity="sha384-3LK/3kTpDE/Pkp8gTNp2gR/2gOiwQ6QaO7Td0zV76UFJVhqLl4Vl3KL1We6q6wR9" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
    <script id="dsq-count-scr" src="//kubevirt-io.disqus.com/count.js" async></script>
    <script src="/js/kubevirt-io.js"></script>
  </body>
</html>
